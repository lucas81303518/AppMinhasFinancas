unit Controller.Usuario;

interface

uses
  ULoginUsuario, DAO.Usuario, UCreateUsuario;

type
  TExecutarApos = procedure of object;

  ControllerUsuario = class
  private
    FDAOUsuario: TDAOUsuario;
    FExecutarApos: TExecutarApos;
  public
    function Login(DtoLogin: TLoginUsuario): string;
    function Cadastrar(DtoCreate: TCreateUsuario): Boolean;
    constructor Create;
    destructor Destroy;

    property OnExecutarApos: TExecutarApos read FExecutarApos write FExecutarApos;
end;

implementation

uses
  System.Threading, System.SysUtils, System.Classes, ThreadingEx, FMX.Dialogs,
  Loading;

{ ControllerUsuario }

function ControllerUsuario.Cadastrar(DtoCreate: TCreateUsuario): Boolean;
begin
   TTaskEx.Run(
    procedure
    begin
      FDAOUsuario.Cadastrar(DtoCreate);
    end)
    .ContinueWith(
      procedure(const LTaskEx: ITaskEx)
        begin
          TThread.Queue(TThread.CurrentThread,
          procedure
          begin
            TLoading.Hide;
            if LTaskEx.ExceptObj <> nil then
              showmessage(LTaskEx.ExceptObj.ToString);
          end);
        end
    , OnlyOnFaulted)
    .ContinueWith(
      procedure(const LTaskEx: ITaskEx)
      begin
        if Assigned(OnExecutarApos) then
          OnExecutarApos();
      end
    , OnlyOnCompleted);
end;

constructor ControllerUsuario.Create;
begin
  inherited;
  FDAOUsuario := TDAOUsuario.Create;
end;

destructor ControllerUsuario.Destroy;
begin
  FDAOUsuario.Destroy;
  inherited;
end;

function ControllerUsuario.Login(DtoLogin: TLoginUsuario): string;
begin
  result := FDAOUsuario.Login(DtoLogin);
end;

end.
